<style>


ul.ui-autocomplete.ui-menu {
  z-index: 1000;
}


input[autocomplete="off"]::-webkit-contacts-auto-fill-button,
input[autocomplete="off"]::-webkit-credentials-auto-fill-button {
visibility: hidden;
display: none !important;
pointer-events: none;
height: 0;
width: 0;
margin: 0;
}
 


</style>

<div class="row">
	<div class="col-xs-12 col-sm-7 col-md-7 col-lg-4">
		<h1 class="page-title txt-color-blueDark"><i class="fa fa-calendar fa-fw "></i> 
			Calendar
			<span>>
			Add events
			</span>
		</h1>
	</div>
	<div class="col-xs-12 col-sm-5 col-md-5 col-lg-8">
		<ul id="sparks" class="">
			<li class="sparks-info">
				
			</li>
			<li class="sparks-info">
				
			</li>
			<li class="sparks-info">
				<h5> Total patients seen <span class="txt-color-greenDark"><i class="fa fa-hopping-cart"></i>&nbsp;{{patientNumbers}}</span></h5>
				<div class="sparkline txt-color-greenDark hidden-mobile hidden-md hidden-sm">
					110,150,300,130,400,240,220,310,220,300, 270, 210
				</div>
			</li>
		</ul>
	</div>
</div>
<!-- row -->

<div class="row">


	<div >
		<!-- new widget -->
		<!-- Modal -->
		<div class="modal fade" id="appointmentModal" tabindex="-1" role="dialog"data-backdrop='static' aria-labelledby="appointmentModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg" role="document">
				<div class="modal-content">
					<div class="modal-header">
							<h5 class="modal-title" id="appointmentModalLabel">New Appointment</h5>
							<button type="button" class="close cancelButton" data-dismiss="modal" aria-label="Close">
									<span aria-hidden="true">&times;</span>
								</button>
						</div>
					<div class="modal-body">
			

					<!-- widget div-->
					<!-- content goes here -->

					<form id="add-event-form" class="appointmentForm ">
						<fieldset>
								<div class="form-group appointmentType">
										<label>Appointment Type</label>
										<div class="dropdown">
											<button class="btn btn-secondary dropdown-toggle" type="button" id="appointmentMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
											  Appointment Type
											</button>
											<div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
											  <a class="dropdown-item appointment-type" name="iconselect" value="New Patient" id="12" href="#">New Patient</a>
											  <a class="dropdown-item appointment-type" name="iconselect2" value="Follow Up" id="423" href="">Follow Up</a>
											  <a class="dropdown-item appointment-type" value="Review" href="">Review</a>
											</div>
										  </div>
									</div>
							<div class="form-group title formBoxes">
								<label>Patient Name</label>
								<input class="form-control paitentDetails"  id="title" name="title" maxlength="40" type="text" placeholder="Patient Name" autocomplete="nope">
							</div>
							
								<div class="form-group phoneNumber formBoxes">
								<label>Phone number</label>
								<input class="form-control paitentDetails"  id="phoneNumber" name="phoneNumber" maxlength="40" type="text"	>
							</div>
							<div class="form-group email formBoxes">
								<label>Email</label>
								<input class="form-control paitentDetails"  id="email" name="email" maxlength="40" type="text"	>
							</div>
							<div class="form-group notes formBoxes">
								<label>Notes</label>
								<textarea class="form-control " placeholder="Notes" rows="3" maxlength="200" id="notes"></textarea>
							</div>
							
							<div class="form-group times formBoxes">
								<label>Start </label>
								<!-- <input class="form-control"  id="start" name="start" maxlength="40" type="text" placeholder="start date"> -->
								<select class="selectpicker">
										<option>1</option>
										<option>2</option>
										<option>3</option>
									  </select>
									<strong >   : </strong>
										
										<select class="selectpicker">
											<option>1</option>
											<option>2</option>
											<option>3</option>
										  </select> 
										  <strong>- </strong>
										  
										  <label>End </label>

										  <select class="selectpicker">
												<option>1</option>
												<option>2</option>
												<option>3</option>
											  </select>
											<strong >   : </strong>
												
												<select class="selectpicker">
													<option>1</option>
													<option>2</option>
													<option>3</option>
												  </select>
							</div>
							
						</fieldset>
					</form>
					<!-- end content -->
				</div>
				<div class="modal-footer">
						<button class="btn btn-primary mb-2 formBoxes" id="addEvent">Add Event</button>
						<button class="btn btn-primary mb-2 cancelButton" id="cancelButton" data-dismiss="modal">Cancel</button>
						</div>
				</div>
				</div>
				</div>
				
			<!-- end widget div -->
		</div>
		
		
		<div id="appointment" class="jarviswidget jarviswidget-color-blueDark " title = "Appointment">
			

			<!-- widget div-->
			<!-- end widget div -->
		</div>
		
		<!-- end widget -->

		
	<div class="col-sm-12">

		<!-- new widget -->
		<div class="jarviswidget jarviswidget-color-blueDark">

			<!-- widget options:
			usage: <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false">

			data-widget-colorbutton="false"
			data-widget-editbutton="false"
			data-widget-togglebutton="false"
			data-widget-deletebutton="false"
			data-widget-fullscreenbutton="false"
			data-widget-custombutton="false"
			data-widget-collapsed="true"
			data-widget-sortable="false"

			-->
			<header>
				<span class="widget-icon"> <i class="fa fa-calendar"></i> </span>
				<h2> Appointments </h2>
				<div class="widget-toolbar">
					<!-- add: non-hidden - to disable auto hide -->
					<div class="btn-group">
						<button class="btn dropdown-toggle btn-xs btn-default" data-toggle="dropdown">
							Showing <i class="fa fa-caret-down"></i>
						</button>
						<button id="addEvent" class="btn dropdown-toggle btn-xs btn-default">
							Add Event <i class="fa fa-caret"></i>
						</button>
						<button id="hideEvent" onclick="hideEvents()" class="btn dropdown-toggle btn-xs btn-default">
							<span class="glyphicon glyphicon-eye-open"><i class="fa fa-caret"></i>
						</button>
						<ul class="dropdown-menu js-status-update pull-right">
							<li>
								<a href="javascript:void(0);" id="mt">Month</a>
							</li>
							<li>
								<a href="javascript:void(0);" id="ag">Week</a>
							</li>
							<li>
								<a href="javascript:void(0);" id="td">Today</a>
							</li>
						</ul>
					</div>
				</div>
			</header>

			<!-- widget div-->
			<div>

				<div class="widget-body no-padding ">
					<!-- content goes here -->
					<div class="widget-body-toolbar">

						<div id="calendar-buttons">

							<div class="btn-group">
								<a href="javascript:void(0)" class="btn btn-default btn-xs" id="btn-prev"><i class="fa fa-chevron-left"></i></a>
								<a href="javascript:void(0)" class="btn btn-default btn-xs" id="btn-next"><i class="fa fa-chevron-right"></i></a>
							</div>
						</div>
					</div>
					<div id="calendar"></div>

					<!-- end content -->
				</div>

			</div>
			<!-- end widget div -->
		</div>
		<!-- end widget -->

	</div>

</div>

<!-- end row -->

<script type="text/javascript">
	/* DO NOT REMOVE : GLOBAL FUNCTIONS!
	 *
	 * pageSetUp(); WILL CALL THE FOLLOWING FUNCTIONS
	 *
	 * // activate tooltips
	 * $("[rel=tooltip]").tooltip();
	 *
	 * // activate popovers
	 * $("[rel=popover]").popover();
	 *
	 * // activate popovers with hover states
	 * $("[rel=popover-hover]").popover({ trigger: "hover" });
	 *
	 * // activate inline charts
	 * runAllCharts();
	 *
	 * // setup widgets
	 * setup_widgets_desktop();
	 *
	 * // run form elements
	 * runAllForms();
	 *
	 ********************************
	 *
	 * pageSetUp() is needed whenever you load a page.
	 * It initializes and checks for all basic elements of the page
	 * and makes rendering easier.
	 *
	 */

	pageSetUp();
	
	/*
	 * ALL PAGE RELATED SCRIPTS CAN GO BELOW HERE
	 * eg alert("my home function");
	 * 
	 * var pagefunction = function() {
	 *   ...
	 * }
	 * loadScript("js/plugin/_PLUGIN_NAME_.js", pagefunction);
	 * 
	 * TO LOAD A SCRIPT:
	 * var pagefunction = function (){ 
	 *  loadScript(".../plugin.js", run_after_loaded);	
	 * }
	 * 
	 * OR
	 * 
	 * loadScript(".../plugin.js", run_after_loaded);
	 */
	
	// PAGE RELATED SCRIPTS

	// pagefunction

	
	
	
	function hideEvents()
    		{
    		
    			
 				$( '.fc-title' ).toggle();
    		}
    		
       
	  
 	
	var fullviewcalendar;
	$('#newEvent').hide();		
	$('#dropEvent').hide();
	var pagefunction = function() {
		
		// full calendar
		
		var date = new Date();
	    var d = date.getDate();
	    var m = date.getMonth();
	    var y = date.getFullYear();
	
	    var hdr = {
	        left: 'title',
	        center: 'month,agendaWeek,agendaDay,week',
	        right: 'prev,today,next'
	    };
	
	 
	
	    var addEvent = function (patientName, appointmentColour, appointmentType, appointmentType  , start , end) {
	        // var html = $('<li><span class="' + priority + '" data-description="' + description + '" data-icon="' + icon + '" data-start="' + start + '" data-end="' + end +'">' + title + '</span></li>').prependTo('ul#external-events').hide().fadeIn();
			var html = $('<li><span class="bg-color-darken txt-color-white" data-description="app" data-icon="dd" data-start="' + start + '" data-end="' + end +'">hello</span></li>').prependTo('ul#external-events').hide().fadeIn();
	
	        $("#event-container").effect("highlight", 800);
	
	    };
	
	    /* initialize the external events
		 -----------------------------------------------------------------*/
	
	    $('#external-events > li').each(function () {
	        initDrag($(this));
	    });
	    
	    /* added functions 
	    ----------------------------------------------------------------*/
	  
	    
	    var aEvent;

		/* ------------------------ Delete Appointment ------------------------ */


	     function deleteEvent () {
	     	$('#calendar').fullCalendar( 'removeEvents' , aEvent._id);
	     	$.ajax({
    						type : "POST",
    						url : "{{ url_for('deleteAppointment') }}",
    						data: JSON.stringify({"id": aEvent.id}),
    						contentType: 'application/json;charset=UTF-8',
    						success: function(result) {
        					//console.log(result);
    						}
						});
	     
	     }
	     
	     /* ------------------------ Delete Appointment End ------------------------ */




		 /*------------------------ Update Appointment ------------------------ */

	     function updateAppointment ()
	     {
			var patientName = $('#appointmentTitle').text(),
	            appointmentType = $('input:radio[name=appointmentIconselect]:checked').val(),
	            start = $('#appointmentStart').val(),
	            end = $('#appointmentEnd').val(),
	            allDay = false,
	            phoneNumber = $("#appointmentPhoneNumber").val(),
	            email = $("#appointmentEmail").val(),
	            notes = $("#appointmentNotes").val();

				if(appointmentType == "New Patient")
				{
					var appointmentColour = "bg-color-darken txt-color-white";
				}
				else
				{
					var appointmentColour = "bg-color-blue txt-color-white";
					
				}     
	    var event;
	     
			             update_appointment = {
									"title": patientName,
			                        "start": start,
			                        "end": end,
			                        "allDay": allDay,
			                        "className": appointmentColour,
									"appointment_type" : appointmentType              
			                    };
			
				$.ajax({
    						type : "POST",
    						url : "{{ url_for('updateAppointment') }}",
    						data: JSON.stringify({
									"id" : aEvent.id,
									"patientName": patientName,
									"phoneNumber": phoneNumber,
									"notes" : notes,
									"email" : email,
			                        "start": start,
			                        "end": end,
			                        "allDay": allDay,
			                        "appointmentColour": appointmentColour,
									"appointmentType" : appointmentType,
			                        "canceled" : false
			                    }),
    						contentType: 'application/json',
    						success: function(result) {
								$('#calendar').fullCalendar( 'removeEvents' , aEvent._id);
								$('#calendar').fullCalendar('renderEvent', update_appointment, true);
    						}
						});
						
						
	     
	     
	
	    }
		/*------------------------ Update Appointment End ------------------------ */


	    /*------------------------ Add Appointment ------------------------ */

	    function addAppointment () {
	        var patientName = $('#title').val(),
	            appointmentType = $('input:radio[name=iconselect]:checked').val(),
	            start = $('#start').val(),
	            end = $('#end').val(),
	            allDay = false,
	            phoneNumber = $("#phoneNumber").val(),
	            email = $("#email").val(),
	            notes = $("#notes").val();

				if(appointmentType == "New Patient")
				{
					var appointmentColour = "bg-color-darken txt-color-white";
				}
				else
				{
					var appointmentColour = "bg-color-blue txt-color-white";
					
				}
			var event;
	        addEvent(patientName, appointmentColour, appointmentType, appointmentType , start , end);
	       if (patientName) {
			   			//Used to render Event on fullcalendar Key Names are important
			             new_appointement =   {
									"title": patientName,
			                        "start": start,
			                        "end": end,
			                        "allDay": allDay,
			                        "className": appointmentColour,
									"appointment_type" : appointmentType,
									"phoneNumber": phoneNumber,
									"notes" : notes,
									"email" : email,             
			                    };
								
			                    
			                   
			                
			            
			            //console.log(event);
			            $.ajax({
    						type : "POST",
    						url : "{{ url_for('addAppointment') }}",
    						data: JSON.stringify({
									"patientName": patientName,
									"phoneNumber": phoneNumber,
									"notes" : notes,
									"email" : email,
			                        "start": start,
			                        "end": end,
			                        "allDay": allDay,
			                        "appointmentColour": appointmentColour,
									"appointmentType" : appointmentType,
			                        "canceled" : false
			                    }),
    						contentType: 'application/json',
    						success: function(result) {
							new_appointement['id'] = result['id']
							$('#calendar').fullCalendar('renderEvent', new_appointement, true);
    						}
						});
		   }
	        
	        
	    };
	    
	    
	    /* ------------------------ Add Appointment End ------------------------ */
		
		function clearForm()
		{
			$('#title').val("");
			$("#phoneNumber").val("");
	        $("#email").val("");
	        $("#notes").val("");
		}


		function changePatientDetails()
		{
			
		}

		function showAppoinmentBoxes(appointmentType)
		{
			if(appointmentType == "Follow Up" || appointmentType == "Review")
			{
				$('.title').show();
				$('.times').show();
				$('#addEvent').show();
				$(".phoneNumber").hide();
	           	$(".email").hide();
				$(".notes").hide();
			}
			else {
				$('.title').show();
				$(".phoneNumber").show();
	           	$(".email").show();
				$(".notes").show();
				$('#addEvent').show();
				$('.times').show();

			}
		}
			
	    var addEventButton = document.getElementById("addEvent")
		addEventButton.addEventListener('click', function() {
			addAppointment();
		});
		
		var typeOfAppointment = document.getElementsByClassName("appointment-type")
		$(".appointment-type").on('click', function(event) {
			event.preventDefault();
			$("#appointmentMenuButton").text(this.text);
			var appointmentType = this.text;
			clearForm();
			showAppoinmentBoxes(appointmentType);
		});
 	
 	$( ".cancelButton" ).button().on( "click", function() {
		$("#appointmentMenuButton").text("Appointment Type");
    });
    
   	
    		
    		
 	 $(function nameSerach() {
    $("#title").autocomplete({
        source:function(request, response) {
            $.getJSON("{{url_for('autocomplete')}}",{
                q: request.term, // in flask, "q" will be the argument to look for using request.args
            }, function(data) {
				
                response(data.matching_results);
               // matching_results from jsonify
            });
        },
        minLength: 2,
        select: function(event, ui) {
			
			if (ui.item.value == "No Results")
			{
				ui.item.value = "";
				
			}
			else{
            $.post("{{url_for('getPatient')}}",{"data" : ui.item.value}, function(results, status){
        		
        		$('#notes').val(results[0].notes)
        		$('#email').val(results[0].email)
				$('#phoneNumber').val(results[0].phoneNumber)
				$(".formBoxes").show();
			});
		
			}
	}
	});
	
})
	

	    fullviewcalendar = $('#calendar').fullCalendar({
	
	        header: hdr,
			        editable: true,
			        droppable: true, // this allows things to be dropped onto the calendar !!!
					eventLimit: true,
					slotDuration: '00:15:00',
					selectable:true,
					defaultView : 'agendaWeek',
					selectHelper : true,
					unselectAuto: true,
					unselectCancel : ".appointmentForm",
					scrollTime : '08:00:00',
					businessHours: { start: '08:00', end: '19:00' },
			        drop: function (date, allDay) { // this function is called when something is dropped
					
			            // retrieve the dropped element's stored Event Object
			            var originalEventObject = $(this).data('eventObject');
			
			            // we need to copy it, so that multiple events don't have a reference to the same object
			            var copiedEventObject = $.extend({}, originalEventObject);
			
			            // assign it the date that was reported
			            copiedEventObject.start = date;
			            copiedEventObject.allDay = allDay;
			
			            // render the event on the calendar
			            // the last `true` argument determines if the event "sticks" (http://arshaw.com/fullcalendar/docs/event_rendering/renderEvent/)
			            $('#calendar').fullCalendar('renderEvent', copiedEventObject, true);
					},
			
			        select: function (start, end, allDay) {
			        
						//RESET FORM when selected 
						$(".formBoxes").hide();
						$(".appointmentType").show();
			        	// $('#title').val("").hide();
	           			// $("#phoneNumber").val("").hide();
	           			// $("#email").val("").hide();
	           			// $("#notes").val("").hide();
			        	// $('#start').val(start.format("YYYY-MM-DD HH:mm")).hide(),
			        	// //end is start plus 45
	            		// $('#end').val( moment(start.format()).add('45' , 'm').format("YYYY-MM-DD HH:mm")).hide();
						$("#appointmentModal").modal('show')
			            $('#calendar').fullCalendar('unselect');
			        	
			        },
			        
			    
			     
			        
			        
			        eventDrop: function(event, delta, revertFunc) {
					
					
    				$.ajax({
    						type : "POST",
    						url : "{{ url_for('updateAppointment') }}",
    						data: JSON.stringify({
    												"id": event.id,
    												"title": event.title,
    												"description":event.description,
    												"start": event.start,
    												"end": event.end,
    												"allDay" : event.allDay,
    												"className": event.className.join(" "),
    												"phoneNumber" : event.phoneNumber,
    												"email" : event.email,
    												"notes" : event.notes
    											}),
    						contentType: 'application/json;charset=UTF-8',
    						success: function(result) {
        					//console.log(result);
    						}
						});

   					//console.log(event);
						$('#calendar').fullCalendar('unselect');
 						 },
 				
					
					//list of event objects stored in the database loaded with page
			        events: 
			         {{event|tojson|safe}},
					
			        eventRender: function (event, element, icon) {
			            if (!event.appointment_type == "") {
							
			                element.find('.fc-title').append("<br/><span class='ultra-light'>" + event.appointment_type +
			                    "</span>");
			            }
			            if (!event.appointment_type == "") {
			                element.find('.fc-title').append("<i class='air air-top-right fa " + event.appointment_type +
			                    " '></i>");
			            }
						//Set values on opening appointment dialog box
			            element.bind('dblclick', function() {
							$('#title').text(event.title).wrapInner("<b />");
	           				$('input[name="iconselect"][value="'+event.appointment_type+'"]').click();
	           				$('#start').val(event.start.format());
	            			$('#end').val(event.end.format());
	           				$("#phoneNumber").val(event.phoneNumber);
	           				$("#email").val(event.email);
	           				$("#notes").val(event.notes);
	           				
							aEvent = event;
							$("#appointmentModal").modal('show')

         					$('#calendar').fullCalendar('unselect');
      					});	
      		
      		
      		
			        },
			        
			        
			
			        windowResize: function (event, ui) {
			            $('#calendar').fullCalendar('render');
			        }
			    });
		
		    /* hide default buttons */
		    $('.fc-right, .fc-center').hide();

		
			$('#calendar-buttons #btn-prev').click(function () {
			    $('.fc-prev-button').click();
			    return false;
			});
			
			$('#calendar-buttons #btn-next').click(function () {
			    $('.fc-next-button').click();
			    return false;
			});
			
			$('#calendar-buttons #btn-today').click(function () {
			    $('.fc-today-button').click();
			    return false;
			});
			
			$('#mt').click(function () {
			    $('#calendar').fullCalendar('changeView', 'month');
			});
			
			$('#ag').click(function () {
			    $('#calendar').fullCalendar('changeView', 'agendaWeek');
			});
			
			$('#td').click(function () {
			    $('#calendar').fullCalendar('changeView', 'agendaDay');
			});	
			
			$('#wk').click(function () {
			    $('#calendar').fullCalendar('changeView', 'listWeek');
			});
					
		
	};
	
	// end pagefunction
	
	// destroy generated instances 

	// destroy generated instances 
	// pagedestroy is called automatically before loading a new page
	// only usable in AJAX version!

	var pagedestroy = function(){

		/*
		Example below:

		$("#calednar").fullCalendar( 'destroy' );
		if (debugState){
			root.console.log("✔ Calendar destroyed");
		} 

		For common instances, such as Jarviswidgets, Google maps, and Datatables, are automatically destroyed through the app.js loadURL mechanic

		*/
		
		fullviewcalendar.fullCalendar( 'destroy' );
		fullviewcalendar = null;
		$("#add-event").off();
		$("#add-event").remove();

		$('#external-events > li').off();
		$('#external-events > li').remove();
		$('#add-event').off();
		$('#add-event').remove();
		$('#calendar-buttons #btn-prev').off();
		$('#calendar-buttons #btn-prev').remove();
		$('#calendar-buttons #btn-next').off();
		$('#calendar-buttons #btn-next').remove();
		$('#calendar-buttons #btn-today').off();
		$('#calendar-buttons #btn-today').remove();
		$('#mt').off();
		$('#mt').remove();
		$('#ag').off();
		$('#ag').remove();
		$('#td').off();
		$('#td').remove();

		if (debugState){
			root.console.log("✔ Calendar destroyed");
		} 
	} 

	// end destroy

	// loadscript and run pagefunction
	loadScript("{{ url_for('static',filename='js/plugin/moment/moment.min.js')}}", function(){
		loadScript("{{ url_for('static',filename='js/plugin/fullcalendar/jquery.fullcalendar.min.js')}}", pagefunction);
		
	});



</script>
